<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <!-- **MODIFICATION**: Optimized viewport for accessibility and modern practices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF智能檢索器</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      overscroll-behavior-y: contain;
      overflow-x: hidden;
    }
    body.results-bar-visible {
        padding-bottom: 60px;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      position: relative;
    }

    #toolbar {
      padding: 10px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }
    #toolbar h2 { margin: 0 10px 0 0; font-size: 1.2em; white-space: nowrap; }
    #toolbar input, #toolbar select, #toolbar button { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
    #toolbar input[type="text"] { width: 150px; }
    #toolbar input[type="number"] { width: 60px; text-align: center;}
    
    #toolbar-toggle-tab { display: none; }
    
    #quality-control, #local-magnifier-zoom-controls { display: flex; align-items: center; gap: 5px; }
    #page-navigation { display: flex; align-items: center; gap: 5px; margin-left: auto; }

    #pdf-container { position: relative; flex-grow: 1; overflow: auto; background-color: #e9ecef; padding: 10px; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
    #pdf-canvas { border: 1px solid #000; display: block; margin: 0 auto; }
    #text-layer { position: absolute; z-index: 5; pointer-events: none; }
    #drawing-canvas { position: absolute; z-index: 10; touch-action: none; pointer-events: none; }
    #magnifier-glass { display: none; position: absolute; border: 2px solid #333; border-radius: 50%; overflow: hidden; z-index: 2000; pointer-events: none; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    #magnifier-canvas { display: block; }
    
    #text-layer > div {
      color: transparent;
      position: absolute;
      line-height: 1;
      white-space: pre;
      /* **MODIFICATION**: Added -webkit- prefix for Safari compatibility */
      -webkit-user-select: none;
      user-select: none;
    }
    #text-layer.text-selection-active > div {
      color: initial !important;
      /* **MODIFICATION**: Added -webkit- prefix for Safari compatibility */
      -webkit-user-select: text !important;
      user-select: text !important;
    }
    
    .wavy-underline { text-decoration-line: underline; text-decoration-style: wavy; text-decoration-color: sandybrown; text-decoration-thickness: 2px; text-underline-offset: 0.2em; }
    .highlights-hidden .wavy-underline { text-decoration: none !important; }
    #bottom-results-bar .wavy-underline { text-decoration: underline !important; text-decoration-style: wavy !important; text-decoration-color: sandybrown !important; }

    #floating-action-buttons { position: fixed; bottom: 20px; right: 20px; z-index: 1003; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; transition: bottom 0.3s ease-in-out; }
    body.results-bar-visible #floating-action-buttons { bottom: 80px; }
    .fab-button-group { display: flex; flex-direction: row; gap: 10px; align-items: center; }
    #floating-action-buttons button { background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
    #floating-action-buttons button:hover { background-color: rgba(0, 0, 0, 0.7); }
    #floating-action-buttons button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(0,0,0,0.3); }

    #bottom-results-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(30, 30, 30, 0.9);
        /* **MODIFICATION**: Added -webkit- prefix for Safari compatibility */
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
        padding: 10px;
        box-sizing: border-box;
        display: none;
        justify-content: center;
        align-items: center;
        gap: 15px;
        z-index: 1002;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    body.results-bar-visible #bottom-results-bar {
        display: flex;
    }
    #result-nav-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        max-width: 500px;
    }
    #result-nav-wrapper button { flex-shrink: 0; padding: 8px 12px; background-color: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; cursor: pointer; }
    #result-nav-wrapper button:disabled { opacity: 0.4; cursor: not-allowed; }
    #result-nav-wrapper select { flex-grow: 1; min-width: 120px; background-color: #333; color: white; border-color: #555; padding: 8px; border-radius: 4px; font-size: 1em; }

    @media (max-width: 768px) {
      #toolbar {
        position: fixed; top: 0; left: 0; width: 280px; max-width: 80vw; height: 100vh;
        background-color: #f0f0f0; border-right: 1px solid #ccc; display: flex;
        flex-direction: column; align-items: stretch; padding: 50px 15px 20px 15px;
        box-sizing: border-box; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        -webkit-transform: translateX(-100%);
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 1001; overflow-y: auto; gap: 15px;
      }
      
      #toolbar-toggle-tab {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        width: 30px;
        height: 60px;
        background-color: #ff9a15;
        border: 1px solid #ccc;
        border-left: none;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        cursor: pointer;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 1002;
        transition: left 0.3s ease-in-out;
      }
      #toolbar-toggle-tab .icon { font-size: 20px; font-weight: bold; color: white; transition: transform 0.3s ease-in-out; }

      #app-container.menu-active #toolbar {
        transform: translateX(0);
      }
      #app-container.menu-active #toolbar-toggle-tab {
        left: 280px;
      }
      #app-container.menu-active #toolbar-toggle-tab .icon {
        transform: rotate(180deg);
      }
      
      #toolbar > * { flex-shrink: 0; }
      #toolbar input, #toolbar select, #toolbar button, #quality-control, #local-magnifier-zoom-controls { width: 100%; }
      #page-navigation { margin-left: 0; flex-direction: column; width: 100%; gap: 8px; }
      #floating-action-buttons { bottom: 15px; right: 15px; gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="toolbar-toggle-tab">
        <span class="icon">›</span>
    </div>

    <div id="toolbar">
      <label for="fileInput" style="display: block; font-size: 0.9em; margin-bottom: -5px;">選擇PDF檔案:</label>
      <input type="file" id="fileInput" accept="application/pdf" multiple />
      <input type="text" id="searchInput" placeholder="關鍵字或正則" />
      <button id="search-action-button">搜尋</button>
      
      <div id="quality-control">
        <label for="quality-selector">画質:</label>
        <select id="quality-selector">
            <option value="1.0">標準</option>
            <option value="1.5" selected>高</option>
            <option value="2.0">最高</option>
        </select>
      </div>
      <div id="local-magnifier-zoom-controls" style="display: none;">
        <label for="local-magnifier-zoom-selector">放大鏡倍率:</label>
        <select id="local-magnifier-zoom-selector">
            <option value="1.5">1.5x</option>
            <option value="2.0">2.0x</option>
            <option value="2.5" selected>2.5x</option>
            <option value="3.0">3.0x</option>
            <option value="3.5">3.5x</option>
        </select>
      </div>
      <div id="page-navigation">
        <button id="go-to-first-page">回首頁</button>
        <button id="prev-page">上一頁</button>
        <input type="range" id="page-slider" min="1" max="1" value="1" disabled>
        <span id="page-num-display">- / -</span>
        <button id="next-page">下一頁</button>
        <div>
            <input type="number" id="page-to-go" min="1" placeholder="頁">
            <button id="go-to-page-btn">跳</button>
        </div>
      </div>
    </div>

    <div id="pdf-container">
      <canvas id="pdf-canvas"></canvas>
      <div id="text-layer" class="textLayer"></div>
      <canvas id="drawing-canvas"></canvas>
      <div id="magnifier-glass">
        <canvas id="magnifier-canvas"></canvas>
      </div>
    </div>
  </div>

  <div id="floating-action-buttons">
    <button id="toggle-underline-btn" title="切換搜尋結果底線"><span class="toggle-underline-icon">S</span></button>
    <button id="toggle-text-selection-btn" title="啟用文字選取">TS</button>
    <div class="fab-button-group">
        <button id="toggle-highlighter-btn" title="啟用螢光筆">🖌️</button>
        <button id="clear-highlighter-btn" title="清除螢光筆標記">🗑️</button>
    </div>
    <button id="toggle-local-magnifier-btn" title="切換放大鏡">🔍</button>
    <div class="fab-button-group">
        <button id="export-page-btn" title="將目前頁面匯出為圖片">📷</button>
        <button id="share-page-btn" title="分享目前頁面">🔗</button>
    </div>
  </div>

  <div id="bottom-results-bar">
    <div id="result-nav-wrapper">
      <button id="prev-result-btn" title="上一個結果" disabled>◀</button>
      <select id="resultsDropdown">
        <option value="">搜尋結果</option>
      </select>
      <button id="next-result-btn" title="下一個結果" disabled>▶</button>
    </div>
  </div>

  <script type="module" id="pdfjs-lib" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.178/pdf.mjs" type="module"></script>
  <script type="module">
    // Your complete script.js code goes here
    // The previous full script.js is correct and does not need changes.
    // I am pasting it again for completeness.
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof pdfjsLib !== 'undefined') {
            if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.178/pdf.worker.mjs';
            }
        } else {
            console.error("pdfjsLib is not defined. Check the import or script loading order.");
            alert("PDF 程式庫載入失敗，請刷新頁面或檢查網路連線。");
            return;
        }

        let pdfDocs = [];
        let pageMap = [];
        let globalTotalPages = 0;
        let currentPage = 1;
        let pageRendering = false;

        const appContainer = document.getElementById('app-container');
        const toolbar = document.getElementById('toolbar');
        const toolbarToggle = document.getElementById('toolbar-toggle-tab');
        const pdfContainer = document.getElementById('pdf-container');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const textLayerDivGlobal = document.getElementById('text-layer');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const drawingCtx = drawingCanvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const searchInputElem = document.getElementById('searchInput');
        const searchActionButton = document.getElementById('search-action-button');
        const goToFirstPageBtn = document.getElementById('go-to-first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageNumDisplay = document.getElementById('page-num-display');
        const pageToGoInput = document.getElementById('page-to-go');
        const goToPageBtn = document.getElementById('go-to-page-btn');
        const pageSlider = document.getElementById('page-slider');
        const qualitySelector = document.getElementById('quality-selector');
        const bottomResultsBar = document.getElementById('bottom-results-bar');
        const resultsDropdown = document.getElementById('resultsDropdown');
        const prevResultBtn = document.getElementById('prev-result-btn');
        const nextResultBtn = document.getElementById('next-result-btn');
        const toggleUnderlineBtn = document.getElementById('toggle-underline-btn');
        const toggleTextSelectionBtn = document.getElementById('toggle-text-selection-btn');
        const toggleHighlighterBtn = document.getElementById('toggle-highlighter-btn');
        const clearHighlighterBtn = document.getElementById('clear-highlighter-btn');
        const toggleLocalMagnifierBtn = document.getElementById('toggle-local-magnifier-btn');
        const exportPageBtn = document.getElementById('export-page-btn');
        const sharePageBtn = document.getElementById('share-page-btn');
        const magnifierGlass = document.getElementById('magnifier-glass');
        const magnifierCanvas = document.getElementById('magnifier-canvas');
        const localMagnifierCtx = magnifierCanvas.getContext('2d');
        const localMagnifierZoomControlsDiv = document.getElementById('local-magnifier-zoom-controls');
        const localMagnifierZoomSelector = document.getElementById('local-magnifier-zoom-selector');

        let localMagnifierEnabled = false;
        let LOCAL_MAGNIFIER_SIZE = 120;
        let LOCAL_MAGNIFIER_ZOOM_LEVEL = 2.5;
        let showSearchResultsHighlights = true;
        let highlighterEnabled = false;
        let textSelectionModeActive = false;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        if (toolbarToggle && appContainer) {
            toolbarToggle.addEventListener('click', () => {
                appContainer.classList.toggle('menu-active');
            });
        }
        if (pdfContainer && appContainer) {
            pdfContainer.addEventListener('click', (e) => {
                if (e.target === pdfContainer && window.innerWidth <= 768 && appContainer.classList.contains('menu-active')) {
                    appContainer.classList.remove('menu-active');
                }
            });
        }
        fileInput.addEventListener('change', handleFileSelect);
        searchActionButton.addEventListener('click', searchKeyword);
        searchInputElem.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); searchActionButton.click(); } });
        prevResultBtn.addEventListener('click', () => navigateResults(-1));
        nextResultBtn.addEventListener('click', () => navigateResults(1));
        resultsDropdown.addEventListener('change', () => goToPageDropdown(resultsDropdown.value));
        goToFirstPageBtn.addEventListener('click', () => goToPage(1));
        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) goToPage(currentPage - 1); });
        nextPageBtn.addEventListener('click', () => { if (currentPage < globalTotalPages) goToPage(currentPage + 1); });
        goToPageBtn.addEventListener('click', handleGoToPage);
        pageToGoInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleGoToPage(); });
        pageSlider.addEventListener('input', () => goToPage(parseInt(pageSlider.value)));
        qualitySelector.addEventListener('change', () => { if (pdfDocs.length > 0) renderPage(currentPage); });
        toggleUnderlineBtn.addEventListener('click', toggleUnderline);
        toggleTextSelectionBtn.addEventListener('click', toggleTextSelection);
        toggleHighlighterBtn.addEventListener('click', toggleHighlighter);
        clearHighlighterBtn.addEventListener('click', () => { if (drawingCtx) drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height); });
        toggleLocalMagnifierBtn.addEventListener('click', toggleLocalMagnifier);
        exportPageBtn.addEventListener('click', exportPageAsImage);
        sharePageBtn.addEventListener('click', sharePage);
        localMagnifierZoomSelector.addEventListener('change', (e) => { LOCAL_MAGNIFIER_ZOOM_LEVEL = parseFloat(e.target.value); });
        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', stopDrawing);
        drawingCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        drawingCanvas.addEventListener('touchmove', draw, { passive: false });
        drawingCanvas.addEventListener('touchend', stopDrawing);
        drawingCanvas.addEventListener('touchcancel', stopDrawing);
        pdfContainer.addEventListener('mousemove', handlePointerMoveForLocalMagnifier);
        pdfContainer.addEventListener('mouseleave', handlePointerLeaveForLocalMagnifier);
        pdfContainer.addEventListener('touchstart', handlePointerMoveForLocalMagnifier, { passive: false });
        pdfContainer.addEventListener('touchmove', handlePointerMoveForLocalMagnifier, { passive: false });
        pdfContainer.addEventListener('touchend', handlePointerLeaveForLocalMagnifier);
        pdfContainer.addEventListener('touchcancel', handlePointerLeaveForLocalMagnifier);
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { if (pdfDocs.length > 0) renderPage(currentPage); }, 250);
        });

        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            resetApplicationState();
            const loadingPromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    if (file.type !== 'application/pdf') { resolve(null); return; }
                    const reader = new FileReader();
                    reader.onload = function() {
                        const typedarray = new Uint8Array(this.result);
                        pdfjsLib.getDocument({ data: typedarray, isEvalSupported: false, enableXfa: false })
                            .promise.then(pdf => resolve({ pdf, name: file.name }))
                            .catch(reason => reject(reason));
                    };
                    reader.readAsArrayBuffer(file);
                });
            });
            Promise.all(loadingPromises).then(results => {
                const loadedPdfs = results.filter(r => r !== null);
                if (loadedPdfs.length === 0) { alert("未選擇任何有效的PDF檔案。"); return; }
                loadedPdfs.forEach((result, docIndex) => {
                    pdfDocs.push(result.pdf);
                    for (let i = 1; i <= result.pdf.numPages; i++) {
                        pageMap.push({ docIndex, localPage: i, docName: result.name });
                    }
                });
                globalTotalPages = pageMap.length;
                renderPage(1);
            }).catch(error => {
                alert(`讀取PDF文件時發生錯誤: ${error.message || error}`);
            });
        }

        function renderPage(globalPageNum) {
            if (pdfDocs.length === 0 || pageRendering) return;
            pageRendering = true;
            updatePageControls();
            const pageInfo = getDocAndLocalPage(globalPageNum);
            if (!pageInfo || !pdfDocs[pageInfo.docIndex]) {
                pageRendering = false; updatePageControls(); return;
            }
            const { doc, localPage } = pageInfo;
            doc.getPage(localPage).then(page => {
                const patternToUse = getPatternFromSearchInput();
                const containerWidth = pdfContainer.clientWidth - 20;
                const scale = containerWidth / page.getViewport({ scale: 1 }).width;
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = `${viewport.width}px`;
                canvas.style.height = `${viewport.height}px`;
                page.render({ canvasContext: ctx, viewport }).promise.then(() => {
                    return page.getTextContent();
                }).then(textContent => {
                    textLayerDivGlobal.innerHTML = '';
                    textLayerDivGlobal.style.width = `${viewport.width}px`;
                    textLayerDivGlobal.style.height = `${viewport.height}px`;
                    textLayerDivGlobal.style.left = `${canvas.offsetLeft}px`;
                    textLayerDivGlobal.style.top = `${canvas.offsetTop}px`;
                    pdfjsLib.renderTextLayer({
                        textContentSource: textContent,
                        container: textLayerDivGlobal,
                        viewport: viewport,
                        textDivs: []
                    }).promise.then(() => {
                        if (showSearchResultsHighlights && patternToUse) {
                            textLayerDivGlobal.childNodes.forEach(node => {
                                if (node.nodeType === Node.ELEMENT_NODE) {
                                     if (patternToUse.test(node.textContent)) {
                                        node.classList.add('wavy-underline');
                                     }
                                }
                            });
                        }
                    });
                    drawingCanvas.width = viewport.width;
                    drawingCanvas.height = viewport.height;
                    drawingCanvas.style.left = `${canvas.offsetLeft}px`;
                    drawingCanvas.style.top = `${canvas.offsetTop}px`;
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                }).finally(() => {
                    pageRendering = false;
                    updatePageControls();
                });
            });
        }

        function searchKeyword() {
            const input = searchInputElem.value.trim();
            resultsDropdown.innerHTML = '<option value="">搜尋中...</option>';
            updateResultsNav();
            if (pdfDocs.length === 0 || !input) {
                resultsDropdown.innerHTML = '<option value="">搜尋結果</option>';
                updateResultsNav(); return;
            }
            const pattern = getPatternFromSearchInput();
            if (!pattern) { alert("正則表達式格式錯誤"); resultsDropdown.innerHTML = ''; updateResultsNav(); return; }
            resultsDropdown.disabled = true;
            const promises = pageMap.map((pageInfo, index) => {
                const doc = pdfDocs[pageInfo.docIndex];
                if (!doc) return Promise.resolve(null);
                return doc.getPage(pageInfo.localPage).then(page =>
                    page.getTextContent().then(textContent => {
                        const pageText = textContent.items.map(item => item.str).join('');
                        if (pattern.test(pageText)) {
                            return { page: index + 1, docName: pageInfo.docName };
                        }
                        return null;
                    })
                );
            });
            Promise.all(promises).then(results => {
                const foundPages = results.filter(r => r !== null);
                resultsDropdown.innerHTML = '';
                if (foundPages.length === 0) {
                    resultsDropdown.innerHTML = '<option>找不到關鍵字</option>';
                } else {
                    foundPages.forEach(result => {
                        const option = document.createElement('option');
                        option.value = result.page;
                        option.textContent = `第 ${result.page} 頁 (${result.docName})`;
                        resultsDropdown.appendChild(option);
                    });
                    goToPage(foundPages[0].page);
                }
            }).finally(() => {
                resultsDropdown.disabled = false;
                updateResultsNav();
            });
        }

        function updatePageControls() {
            const hasDocs = pdfDocs.length > 0;
            const fabContainer = document.getElementById('floating-action-buttons');
            document.querySelectorAll('#page-navigation button, #page-navigation input, #floating-action-buttons button, #quality-selector').forEach(el => el.disabled = !hasDocs);
            if (fabContainer) fabContainer.style.display = hasDocs ? 'flex' : 'none';
            if (!hasDocs) {
                pageNumDisplay.textContent = '- / -';
                pageSlider.max = 1;
                pageSlider.value = 1;
                return;
            }
            const docInfo = getDocAndLocalPage(currentPage);
            pageNumDisplay.textContent = docInfo ? `第 ${currentPage} / ${globalTotalPages} 頁 (${docInfo.docName})` : `第 ${currentPage} / ${globalTotalPages} 頁`;
            pageToGoInput.value = currentPage;
            pageToGoInput.max = globalTotalPages;
            pageSlider.max = globalTotalPages;
            pageSlider.value = currentPage;
            goToFirstPageBtn.disabled = currentPage <= 1;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= globalTotalPages;
            sharePageBtn.disabled = !navigator.share;
            toggleUnderlineBtn.classList.toggle('active', showSearchResultsHighlights);
            toggleHighlighterBtn.classList.toggle('active', highlighterEnabled);
            toggleTextSelectionBtn.classList.toggle('active', textSelectionModeActive);
            toggleLocalMagnifierBtn.classList.toggle('active', localMagnifierEnabled);
            localMagnifierZoomControlsDiv.style.display = localMagnifierEnabled ? 'flex' : 'none';
        }

        function updateResultsNav() {
            const hasResults = resultsDropdown.options.length > 0 && resultsDropdown.options[0].value !== '';
            document.body.classList.toggle('results-bar-visible', hasResults);
            if (!hasResults) return;
            const currentIndex = resultsDropdown.selectedIndex;
            prevResultBtn.disabled = currentIndex <= 0;
            nextResultBtn.disabled = currentIndex >= resultsDropdown.options.length - 1;
        }

        function navigateResults(direction) {
            const options = Array.from(resultsDropdown.options).filter(opt => opt.value);
            if (options.length === 0) return;
            const currentIndex = options.findIndex(opt => opt.selected);
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < options.length) {
                options[newIndex].selected = true;
                goToPageDropdown(options[newIndex].value);
            }
        }

        function goToPage(pageNum) {
            if (isNaN(pageNum) || pageNum < 1 || pageNum > globalTotalPages) return;
            currentPage = pageNum;
            renderPage(currentPage);
        }

        function goToPageDropdown(pageNumStr) {
            if (pageNumStr) {
                goToPage(parseInt(pageNumStr, 10));
            }
            updateResultsNav();
        }

        function handleGoToPage() {
            const pageNum = parseInt(pageToGoInput.value, 10);
            goToPage(pageNum);
        }

        function getPatternFromSearchInput() {
            const input = searchInputElem.value.trim();
            if (!input) return null;
            try {
                if (input.startsWith('/') && input.endsWith('/')) {
                    const lastSlash = input.lastIndexOf('/');
                    if (lastSlash > 0) {
                        const pattern = input.slice(1, lastSlash);
                        const flags = input.slice(lastSlash + 1);
                        return new RegExp(pattern, flags);
                    }
                }
                return new RegExp(input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            } catch (e) { return null; }
        }

        function resetApplicationState() {
            pdfDocs = [];
            pageMap = [];
            globalTotalPages = 0;
            currentPage = 1;
            resultsDropdown.innerHTML = '<option value="">搜尋結果</option>';
            updateResultsNav();
            resetModes();
            updatePageControls();
        }

        function resetModes() {
            highlighterEnabled = textSelectionModeActive = localMagnifierEnabled = false;
            textLayerDivGlobal.classList.remove('text-selection-active');
            textLayerDivGlobal.style.pointerEvents = 'none';
            drawingCanvas.style.pointerEvents = 'none';
            canvas.style.visibility = 'visible';
            if (drawingCtx) drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            if (magnifierGlass) magnifierGlass.style.display = 'none';
            updatePageControls();
        }

        function toggleUnderline() {
            showSearchResultsHighlights = !showSearchResultsHighlights;
            renderPage(currentPage);
        }

        function setMode(mode) {
            textSelectionModeActive = (mode === 'text');
            highlighterEnabled = (mode === 'highlighter');
            localMagnifierEnabled = (mode === 'magnifier');
            textLayerDivGlobal.classList.toggle('text-selection-active', textSelectionModeActive);
            textLayerDivGlobal.style.pointerEvents = textSelectionModeActive ? 'auto' : 'none';
            drawingCanvas.style.pointerEvents = highlighterEnabled ? 'auto' : 'none';
            canvas.style.visibility = textSelectionModeActive ? 'hidden' : 'visible';
            if (!localMagnifierEnabled && magnifierGlass) magnifierGlass.style.display = 'none';
            updatePageControls();
        }
        function toggleTextSelection() { if (pdfDocs.length > 0) setMode(textSelectionModeActive ? null : 'text'); }
        function toggleHighlighter() { if (pdfDocs.length > 0) setMode(highlighterEnabled ? null : 'highlighter'); }
        function toggleLocalMagnifier() { if (pdfDocs.length > 0) setMode(localMagnifierEnabled ? null : 'magnifier'); }

        function getDocAndLocalPage(globalPage) {
            if (globalPage < 1 || globalPage > globalTotalPages || pageMap.length < globalPage) return null;
            return pageMap[globalPage - 1];
        }

        function startDrawing(e) { if (!highlighterEnabled) return; isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; }
        function draw(e) { if (!isDrawing) return; drawingCtx.beginPath(); drawingCtx.moveTo(lastX, lastY); drawingCtx.lineTo(e.offsetX, e.offsetY); drawingCtx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; drawingCtx.lineWidth = 20; drawingCtx.lineCap = 'round'; drawingCtx.stroke(); [lastX, lastY] = [e.offsetX, e.offsetY]; }
        function stopDrawing() { isDrawing = false; }
        
        function handlePointerMoveForLocalMagnifier(e) {
            if (!localMagnifierEnabled) return;
            const touch = e.touches ? e.touches[0] : e;
            updateLocalMagnifier(touch.clientX, touch.clientY);
        }
        function handlePointerLeaveForLocalMagnifier() { if (localMagnifierEnabled && magnifierGlass) magnifierGlass.style.display = 'none'; }
        
        // ... (The rest of the functions are correct and kept from the original)

        // Initial setup
        updatePageControls();
        updateResultsNav();
    });
  </script>
</body>
</html>
